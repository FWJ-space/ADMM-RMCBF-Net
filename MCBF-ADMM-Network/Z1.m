%     clc
%     clear
function [ W11, W12, lambda111,lambda112,lambda121,lambda122,t121, t122,t211,t212] ...
         = Z1(rho1,mu1,v1,t,H1,H2,c)
% H1 = [[1.1711028959645469,1.2031211952354426,-0.3458515081653286,-0.41338808307243907,0.5153161664713992,-0.5739553351971034,-0.04260846738839321,-0.8061049495166199],[0.3386843954970631,0.6625962894036347,-0.7048846452707695,1.0207076024193182,0.9831744884125184,-0.009050823137756054,-1.3811774920974969,0.6738500400572865],[0.09705859812481742,-0.5313034453461218,0.28977809936056387,-0.35165660225441253,-1.3108826320251064,0.4166675756881427,0.6695812523127679,-0.03525935755036044],[-0.29604457949419355,0.39217793756993063,-0.5112105520301234,-0.24361818849450703,0.7948198341050781,0.41891970581897314,0.6605466782796992,-0.07441035280958799],[-0.11861770834434097,-0.6298409884177596,0.48029305406721984,0.3036641966422713,-0.1407858780255788,-0.8344814694649862,-0.2252715169683619,1.113836325790966],[-0.5074472529526455,0.385994339211384,0.25038492420552216,-0.8724271558602841,-0.2051531348482146,-0.32473209275127907,1.480733292190507,0.29562524969903037],[0.5986560800224959,0.4416629461667343,0.4462908025712313,1.2012635266469995,-0.7669607789821732,0.06900105548044709,0.979538500608168,-0.9525633159770006],[0.7890524522181288,0.4450864064676565,-0.5763128261301413,0.44684278505948344,0.8181714314596277,-0.008961205600898529,0.8250762151183662,-0.9034402580020077]];
% H2 = [[0.552244019490021,-0.192210409732857,-0.22008859007071246,-0.12127286891095121,0.38825480464022566,0.7100466754163717,0.8247899371691284,-0.23299034253593737],[1.134335984290415,-0.8632143200452947,-0.20137837256270963,0.526687235467968,0.15963537918361023,-0.007979389313218524,-0.3560569518543982,0.25512875331210977],[0.11393605590312346,0.1281753062680745,0.6554756743442395,-0.27366895808132397,-0.317257773973268,0.5100982328486244,-0.6006446962767438,-0.37093992149455696],[0.4825401309313719,-0.07143503237067363,-0.2730440764268353,-1.3169802092932144,0.07548627238214538,-0.37262470045242724,0.44826875427438617,-0.9361626015029803],[-0.22462954885363615,-0.13559993508503282,-0.02930666499075407,0.012834512686677695,-0.11561000841620195,0.2784579121344946,0.8634063727398644,-0.17383613519023194],[-0.13183865376192097,0.07736360756200907,-0.7599701828362484,0.6301650190743242,0.08294941487698905,0.8236111227029594,1.1401846440879684,-0.7107756289379241],[0.14417925973241127,0.2850500418757408,0.8705042364076738,-0.4021407336169876,0.02565465613148819,-0.956140213430271,0.4253834696698101,1.4955649087243552],[-0.593998320176398,0.6306402520443924,0.9305398286939004,0.6451790407742267,-0.09724799329520051,0.4116830768353889,0.37075182223555236,1.1320090428093463]];
% H1 =reshape(H1,8,8);
% H2 =reshape(H2,8,8);
% t=zeros(Nc*(Nc-1)*k,1);%所有的小区间干扰
% rho1=0;
% rho2=0;%松弛变量
% mu1=0;
% mu2=0;%p1=rho1的对偶变量
% v1=zeros(Nc*k,1);
% v2=zeros(Nc*k,1);%t1=E1*t的对偶变量
% c=100000;

warning('off');
%输出 10

% 常数定义
Nt=8;%天线数
Nc=2;%小区数
k=2;%每个基站对应移动台数
N=Nc.^2.*k;%信道h的数量
gamma=10;%设定信噪比阈值γ
epsilon=0.05;%设定球形误差模型的误差半径ε
I=eye(Nt); %生成维度为Nt单位矩阵
Q=epsilon.^-2*I;
sigma=0.02;%噪声功率




E1=[0 0 1 0;
    0 0 0 1;
    1 0 0 0;
    0 1 0 0];%线性映射矩阵
E2=[1 0 0 0;
    0 1 0 0;
    0 0 1 0;
    0 0 0 1];

phi11=zeros(Nt+1,Nt+1);
phi12=zeros(Nt+1,Nt+1);
phi21=zeros(Nt+1,Nt+1);
phi22=zeros(Nt+1,Nt+1);
psi121=zeros(Nt+1,Nt+1);
psi122=zeros(Nt+1,Nt+1);
psi211=zeros(Nt+1,Nt+1);
psi212=zeros(Nt+1,Nt+1);


E=[E1.' E2.'].';



%参数输入
%c=10.^-6;%惩罚参数



% rho1=0;
% rho2=0;%松弛变量
% mu1=0;
% mu2=0;%p1=rho1的对偶变量
%  v1=zeros(Nc*k,1);
% v2=zeros(Nc*k,1);%t1=E1*t的对偶变量
% 
% 
%  t=zeros(Nc*(Nc-1)*k,1);%所有的小区间干扰
% 
% %生成N个信道
% for j=1:N 
%    j;
%    h_head=sqrt(0.5)*randn(Nt,1)+1i*sqrt(0.5)*randn(Nt,1);   %产生服从复高斯随机的预定的信道向量
%    H(:,j)=h_head;%信道衰落*1.739*10^-4,将生成的信道放到信道矩阵中
% end  
%对生成信道进行编号，h111指第一个基站对第一个基站的第一个接收台的信道
H = H1+1i*H2;

h111=H(:,1);
h112=H(:,3);
h221=H(:,5);
h222=H(:,7);
h121=H(:,6);
h122=H(:,8);
h211=H(:,2);
h212=H(:,4);

        
            %基站1 Z层
        cvx_begin sdp quiet  %sdp:调用半确定编程模式;quiet:防止模型在解算时产生任何屏幕输出。cvx_begin sdp quiet会调用SDP模式并使求解器输出无效。
        variable W11(Nt,Nt) nonnegative semidefinite;
        variable W12(Nt,Nt) nonnegative semidefinite;
        variable lambda111; 
        variable lambda112;
        variable lambda121;
        variable lambda122;%表示λ，松弛变量
        variable t121;
        variable t122;
        variable t211;
        variable t212;%表示最差情况下小区间干扰
        variable t1(Nc*k,1)%[t211,t212,t121,t122]
        variable p1
        
        %式29a
        %pn=trace(W11)+trace(W12)
        %rho1为ρn，所以Σ(ρn-pn)^2=(rho1-(trace(W11)+trace(W12)))*(rho1-(trace(W11)+trace(W12)))
        
%         minimize (trace(W11)+trace(W12)+c/2.*(rho1-(trace(W11)+trace(W12)))*(rho1-(trace(W11)+trace(W12)))...
%         +c/2.*square_pos((norm(E1*t-[t211,t212,t121,t122]',2)))...
%     -v1.'*(E1*t-[t211,t212,t121,t122]')...
% -mu1.*(rho1-(trace(W11)+trace(W12)))); 
         minimize (trace(W11)+trace(W12) + (c/2)*((rho1-(trace(W11)+trace(W12)))*(rho1-(trace(W11)+trace(W12))))...
        +c/2.*square_pos((norm(E1*t-[t211,t212,t121,t122]',2)))...
    -v1.'*([t211,t212,t121,t122]')...
-mu1.*((trace(W11)+trace(W12)))); 
        subject to 
        phi11=[(1/gamma).*W11-W12+lambda111.*Q,((1/gamma).*W11-W12)* h111;h111'*((1/gamma).*W11-W12),h111'*((1/gamma).*W11-W12)*h111-lambda111-t211-sigma.^2]>=0;
        phi12=[(1/gamma).*W12-W11+lambda112.*Q,((1/gamma).*W12-W11)* h112;h112'*((1/gamma).*W12-W11),h112'*((1/gamma).*W12-W11)*h112-lambda112-t212-sigma.^2]>=0;
        psi121=[-(W11+W12)+lambda121*Q,-(W11+W12)*h121;-h121'*(W11+W12),-h121'*(W11+W12)*h121+t121-lambda121]>=0;
        psi122=[-(W11+W12)+lambda122*Q,-(W11+W12)*h122;-h122'*(W11+W12),-h122'*(W11+W12)*h122+t122-lambda122]>=0;
        lambda111>=0;
        lambda112>=0;
        lambda121>=0;
        lambda122>=0;
        W11>=0;
        W12>=0;
        t121>=0;
        t122>=0;
        t211>=0;
        t212>=0;
%         p1>0
        cvx_end
        t1211=t121;
        t1221=t122;
        t2111=t211;
        t2121=t212;
         
        
        
        
        
        